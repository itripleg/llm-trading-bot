<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alpha Arena Mini - Analysis Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <!-- Compact Header -->
        <header>
            <div class="header-top">
                <h1>Alpha Arena Mini</h1>
                <div class="header-controls">
                    <div class="bot-status-compact">
                        <span class="status-indicator unknown" id="status-dot"></span>
                        <span id="status-text">Stopped</span>
                    </div>
                    <div class="bot-controls">
                        <button class="bot-control-btn start-btn" id="start-btn">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M5 3.5v9L12 8z"/>
                            </svg>
                            Start
                        </button>
                        <button class="bot-control-btn pause-btn" id="pause-btn" style="display: none;">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M5 3h2v10H5V3zm4 0h2v10H9V3z"/>
                            </svg>
                            Pause
                        </button>
                        <button class="bot-control-btn stop-btn" id="stop-btn" style="display: none;">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <rect x="4" y="4" width="8" height="8"/>
                            </svg>
                            Stop
                        </button>
                    </div>
                </div>
            </div>
            <div class="header-stats-compact">
                <div class="stat-compact">
                    <span class="label">Balance</span>
                    <span class="value" id="balance">$0.00</span>
                </div>
                <div class="stat-compact">
                    <span class="label">Realized PnL</span>
                    <span class="value" id="realized-pnl">$0.00</span>
                </div>
                <div class="stat-compact">
                    <span class="label">Unrealized PnL</span>
                    <span class="value" id="unrealized-pnl">$0.00</span>
                </div>
                <div class="stat-compact">
                    <span class="label">Decisions</span>
                    <span class="value" id="total-decisions">0</span>
                </div>
                <div class="stat-compact">
                    <span class="label">Last Update</span>
                    <span class="value" id="last-update">Never</span>
                </div>
            </div>
        </header>

        <!-- Latest Decision - Main Focus -->
        <section class="latest-decision" id="latest-decision-section">
            <div class="section-header">
                <h2>Latest Analysis</h2>
                <div class="decision-nav" id="decision-nav" style="display: none;">
                    <button class="nav-btn" id="prev-btn" title="Previous decision">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"/>
                        </svg>
                        Previous
                    </button>
                    <span class="nav-indicator" id="nav-indicator">1 of 1</span>
                    <button class="nav-btn" id="next-btn" title="Next decision">
                        Next
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="latest-decision-card">
                <div class="no-data-card">No decisions yet. Run test_real_data.py to analyze market conditions.</div>
            </div>
        </section>

        <!-- Bot Activity Console -->
        <section class="bot-activity">
            <div class="section-header">
                <h2>Bot Activity</h2>
                <span class="activity-subtitle">Real-time bot status and logs</span>
            </div>

            <!-- System Prompt (static, shown once) -->
            <div class="system-prompt-section" id="system-prompt-section" style="margin-bottom: 20px;">
                <button class="raw-data-btn" onclick="toggleSystemPrompt()" style="max-width: 300px;">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M3 2.5a2.5 2.5 0 0 1 5 0 2.5 2.5 0 0 1 5 0v.006c0 .07 0 .27-.038.494H15a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1v7.5a1.5 1.5 0 0 1-1.5 1.5h-11A1.5 1.5 0 0 1 1 14.5V7a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h2.038A2.968 2.968 0 0 1 3 2.506V2.5zm1.068.5H7v-.5a1.5 1.5 0 1 0-3 0c0 .085.002.274.045.43a.522.522 0 0 0 .023.07zM9 3h2.932a.56.56 0 0 0 .023-.07c.043-.156.045-.345.045-.43a1.5 1.5 0 0 0-3 0V3zM1 4v2h6V4H1zm8 0v2h6V4H9zm5 3H9v8h4.5a.5.5 0 0 0 .5-.5V7zm-7 8V7H2v7.5a.5.5 0 0 0 .5.5H7z"/>
                    </svg>
                    View System Prompt (Trading Instructions)
                </button>
                <div class="raw-data-content" id="system-prompt-content" style="display: none;">
                    <h4 style="margin-top: 0; color: #333;">System Prompt (same for all decisions):</h4>
                    <pre><code id="system-prompt-text">Loading...</code></pre>
                </div>
            </div>

            <!-- Activity Log -->
            <h3 style="font-size: 1rem; margin-bottom: 12px; color: #495057;">Activity Log</h3>
            <div class="activity-console" id="activity-console">
                <div class="console-message">Waiting for bot activity...</div>
            </div>
        </section>

        <!-- Positions (Compact when empty) -->
        <section class="positions-compact" id="positions-section" style="display: none;">
            <h2>Active Positions</h2>
            <div id="positions-list"></div>
        </section>

        <!-- Database Debug Section -->
        <section class="database-debug">
            <div class="section-header">
                <h2>Database Debug</h2>
                <span class="activity-subtitle">Raw database entries for inspection</span>
            </div>

            <!-- Table selector -->
            <div style="margin-bottom: 16px;">
                <label for="debug-table-select" style="margin-right: 8px; font-weight: 500;">Table:</label>
                <select id="debug-table-select" style="padding: 6px 12px; border: 1px solid #ced4da; border-radius: 4px;">
                    <option value="decisions">Decisions</option>
                    <option value="account_state">Account State</option>
                    <option value="positions">Positions</option>
                    <option value="bot_status">Bot Status</option>
                </select>
                <button onclick="loadDebugData()" style="margin-left: 8px; padding: 6px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Reload</button>
            </div>

            <!-- Database entries display -->
            <div id="debug-entries" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 16px; max-height: 600px; overflow-y: auto;">
                <div style="color: #6c757d;">Loading...</div>
            </div>
        </section>
    </div>

    <script>
        // API endpoints
        const API = {
            account: '/api/account',
            decisions: '/api/decisions',
            positions: '/api/positions',
            status: '/api/status',
            stats: '/api/stats',
            botStatus: '/api/bot/status',
            botStart: '/api/bot/start',
            botPause: '/api/bot/pause',
            botResume: '/api/bot/resume',
            botStop: '/api/bot/stop',
            debugDatabase: '/api/debug/database'
        };

        let allDecisions = [];
        let currentDecisionIndex = 0;

        // Format currency
        function formatCurrency(value) {
            return '$' + value.toFixed(2);
        }

        // Format date/time
        function formatDateTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Format relative time
        function formatRelativeTime(isoString) {
            // Ensure UTC parsing by adding 'Z' if not present
            const utcString = isoString.endsWith('Z') ? isoString : isoString + 'Z';
            const date = new Date(utcString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours}h ago`;
            const diffDays = Math.floor(diffHours / 24);
            return `${diffDays}d ago`;
        }

        // Get PnL class
        function getPnLClass(value) {
            if (value > 0) return 'positive';
            if (value < 0) return 'negative';
            return 'neutral';
        }

        // Parse justification into structured sections
        function parseJustification(text) {
            const sections = {
                analysis: [],
                risks: [],
                waiting: [],
                other: []
            };

            // Split by periods and parse numbered points
            const sentences = text.split('. ');
            let currentSection = 'analysis';

            sentences.forEach(sentence => {
                const trimmed = sentence.trim();

                if (trimmed.includes('RISKS:')) {
                    currentSection = 'risks';
                } else if (trimmed.includes('WAITING for:')) {
                    currentSection = 'waiting';
                } else if (trimmed.match(/^\(\d+\)/)) {
                    // Numbered point
                    sections.analysis.push(trimmed);
                } else if (currentSection === 'risks' && trimmed.length > 0) {
                    sections.risks.push(trimmed);
                } else if (currentSection === 'waiting' && trimmed.length > 0) {
                    sections.waiting.push(trimmed);
                } else if (trimmed.length > 0) {
                    sections.other.push(trimmed);
                }
            });

            return sections;
        }

        // Create decision card HTML
        function createDecisionCard(decision, isLatest = false) {
            const sections = parseJustification(decision.justification);
            const timestamp = formatDateTime(decision.timestamp);
            const relativeTime = formatRelativeTime(decision.timestamp);

            const cardClass = isLatest ? 'decision-card latest' : 'decision-card';

            let html = `
                <div class="${cardClass}">
                    <div class="decision-header">
                        <div class="decision-meta">
                            <span class="decision-coin">${decision.coin}</span>
                            <span class="decision-time" title="${timestamp}">${relativeTime}</span>
                        </div>
                        <div class="decision-signal-badge ${decision.signal}">
                            ${decision.signal.toUpperCase().replace('_', ' ')}
                        </div>
                    </div>

                    <div class="decision-metrics">
                        <div class="metric">
                            <span class="metric-label">Confidence</span>
                            <span class="metric-value">${(decision.confidence * 100).toFixed(0)}%</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Size</span>
                            <span class="metric-value">$${decision.quantity_usd.toFixed(0)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Leverage</span>
                            <span class="metric-value">${decision.leverage}x</span>
                        </div>
            `;

            // Show entry price for buy/sell/hold decisions
            if ((decision.signal === 'buy_to_enter' || decision.signal === 'sell_to_enter' || decision.signal === 'hold') && decision.entry_price) {
                html += `
                        <div class="metric">
                            <span class="metric-label">Entry</span>
                            <span class="metric-value">$${decision.entry_price.toFixed(0)}</span>
                        </div>
                `;
            }

            // Show exit price and PnL for close decisions
            if (decision.signal === 'close' && decision.exit_price) {
                html += `
                        <div class="metric">
                            <span class="metric-label">Exit</span>
                            <span class="metric-value">$${decision.exit_price.toFixed(0)}</span>
                        </div>
                `;
                if (decision.realized_pnl !== null && decision.realized_pnl !== undefined) {
                    const pnlClass = decision.realized_pnl > 0 ? 'positive' : decision.realized_pnl < 0 ? 'negative' : '';
                    html += `
                        <div class="metric">
                            <span class="metric-label">PnL</span>
                            <span class="metric-value ${pnlClass}">$${decision.realized_pnl.toFixed(2)}</span>
                        </div>
                    `;
                }
            }

            // Continue with original metrics
            html += ``;

            if (decision.profit_target) {
                html += `
                        <div class="metric">
                            <span class="metric-label">Target</span>
                            <span class="metric-value positive">$${decision.profit_target.toFixed(0)}</span>
                        </div>
                `;
            }

            if (decision.stop_loss) {
                html += `
                        <div class="metric">
                            <span class="metric-label">Stop</span>
                            <span class="metric-value negative">$${decision.stop_loss.toFixed(0)}</span>
                        </div>
                `;
            }

            html += `</div>`;

            // Analysis section
            if (sections.analysis.length > 0) {
                html += `
                    <div class="analysis-section">
                        <h4>Analysis</h4>
                        <ul class="analysis-points">
                `;
                sections.analysis.forEach(point => {
                    // Remove existing (N) prefix if present since <li> will auto-number
                    const cleanPoint = point.replace(/^\(\d+\)\s*/, '');
                    html += `<li>${cleanPoint}</li>`;
                });
                html += `</ul></div>`;
            }

            // Risks section
            if (sections.risks.length > 0) {
                html += `
                    <div class="risks-section">
                        <h4>Risks Identified</h4>
                        <ul class="risk-points">
                `;
                sections.risks.forEach(risk => {
                    // Remove existing (N) prefix if present since <li> will auto-number
                    const cleanRisk = risk.replace(/^\(\d+\)\s*/, '');
                    html += `<li>${cleanRisk}</li>`;
                });
                html += `</ul></div>`;
            }

            // Waiting section
            if (sections.waiting.length > 0) {
                html += `
                    <div class="waiting-section">
                        <h4>Waiting For</h4>
                        <ul class="waiting-points">
                `;
                sections.waiting.forEach(condition => {
                    // Remove existing (N) prefix if present since <li> will auto-number
                    const cleanCondition = condition.replace(/^\(\d+\)\s*/, '');
                    html += `<li>${cleanCondition}</li>`;
                });
                html += `</ul></div>`;
            }

            // Other text
            if (sections.other.length > 0) {
                html += `
                    <div class="other-analysis">
                        <p>${sections.other.join('. ')}</p>
                    </div>
                `;
            }

            // Invalidation condition (if exists and not already in sections)
            if (decision.invalidation_condition && !decision.justification.includes('invalidation')) {
                html += `
                    <div class="invalidation">
                        <strong>Invalidation:</strong> ${decision.invalidation_condition}
                    </div>
                `;
            }

            // Raw data button and collapsible section
            const rawDataId = `raw-data-${decision.id}`;
            const rawData = {
                id: decision.id,
                timestamp: decision.timestamp,
                coin: decision.coin,
                signal: decision.signal,
                quantity_usd: decision.quantity_usd,
                leverage: decision.leverage,
                confidence: decision.confidence,
                exit_plan: {
                    profit_target: decision.profit_target,
                    stop_loss: decision.stop_loss,
                    invalidation_condition: decision.invalidation_condition
                },
                justification: decision.justification
            };

            // Add View Prompt button (user prompt only - market data)
            const promptId = `prompt-${decision.id}`;
            const hasUserPrompt = decision.user_prompt;

            html += `
                <div class="raw-data-section">
                    ${hasUserPrompt ? `
                    <button class="raw-data-btn" onclick="togglePrompt('${promptId}')" style="margin-right: 8px;">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M3 2.5a2.5 2.5 0 0 1 5 0 2.5 2.5 0 0 1 5 0v.006c0 .07 0 .27-.038.494H15a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1v7.5a1.5 1.5 0 0 1-1.5 1.5h-11A1.5 1.5 0 0 1 1 14.5V7a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h2.038A2.968 2.968 0 0 1 3 2.506V2.5zm1.068.5H7v-.5a1.5 1.5 0 1 0-3 0c0 .085.002.274.045.43a.522.522 0 0 0 .023.07zM9 3h2.932a.56.56 0 0 0 .023-.07c.043-.156.045-.345.045-.43a1.5 1.5 0 0 0-3 0V3zM1 4v2h6V4H1zm8 0v2h6V4H9zm5 3H9v8h4.5a.5.5 0 0 0 .5-.5V7zm-7 8V7H2v7.5a.5.5 0 0 0 .5.5H7z"/>
                        </svg>
                        View Market Data Prompt
                    </button>
                    ` : ''}
                    <button class="raw-data-btn" onclick="toggleRawData('${rawDataId}')">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M5.854 4.646a.5.5 0 1 0-.708.708L8.293 8.5l-3.147 3.146a.5.5 0 0 0 .708.708l3.5-3.5a.5.5 0 0 0 0-.708l-3.5-3.5z"/>
                            <path d="M4.5 1a.5.5 0 0 0-.5.5v13a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5v-13a.5.5 0 0 0-.5-.5h-7zm0-1h7A1.5 1.5 0 0 1 13 1.5v13a1.5 1.5 0 0 1-1.5 1.5h-7A1.5 1.5 0 0 1 3 14.5v-13A1.5 1.5 0 0 1 4.5 0z"/>
                        </svg>
                        View Raw Data
                    </button>
                    ${hasUserPrompt ? `
                    <div class="raw-data-content" id="${promptId}" style="display: none;">
                        <h4 style="margin-top: 0; color: #333;">Market Data Prompt:</h4>
                        <pre><code>${decision.user_prompt || 'Not available'}</code></pre>
                    </div>
                    ` : ''}
                    <div class="raw-data-content" id="${rawDataId}" style="display: none;">
                        <pre><code>${JSON.stringify(rawData, null, 2)}</code></pre>
                    </div>
                </div>
            `;

            html += `</div>`;
            return html;
        }

        // Toggle raw data visibility
        function toggleRawData(elementId) {
            const element = document.getElementById(elementId);
            const button = element.previousElementSibling;

            if (element.style.display === 'none') {
                element.style.display = 'block';
                expandedSections.add(elementId);  // Track expanded state
                button.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
                    </svg>
                    Hide Raw Data
                `;
            } else {
                element.style.display = 'none';
                expandedSections.delete(elementId);  // Remove from tracked state
                button.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M5.854 4.646a.5.5 0 1 0-.708.708L8.293 8.5l-3.147 3.146a.5.5 0 0 0 .708.708l3.5-3.5a.5.5 0 0 0 0-.708l-3.5-3.5z"/>
                        <path d="M4.5 1a.5.5 0 0 0-.5.5v13a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5v-13a.5.5 0 0 0-.5-.5h-7zm0-1h7A1.5 1.5 0 0 1 13 1.5v13a1.5 1.5 0 0 1-1.5 1.5h-7A1.5 1.5 0 0 1 3 14.5v-13A1.5 1.5 0 0 1 4.5 0z"/>
                    </svg>
                    View Raw Data
                `;
            }
        }

        // Toggle prompt visibility (for individual decision market data)
        function togglePrompt(elementId) {
            const element = document.getElementById(elementId);
            const button = event.currentTarget;

            if (element.style.display === 'none') {
                element.style.display = 'block';
                expandedSections.add(elementId);  // Track expanded state
                button.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
                    </svg>
                    Hide Market Data Prompt
                `;
            } else {
                element.style.display = 'none';
                expandedSections.delete(elementId);  // Remove from tracked state
                button.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M3 2.5a2.5 2.5 0 0 1 5 0 2.5 2.5 0 0 1 5 0v.006c0 .07 0 .27-.038.494H15a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1v7.5a1.5 1.5 0 0 1-1.5 1.5h-11A1.5 1.5 0 0 1 1 14.5V7a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h2.038A2.968 2.968 0 0 1 3 2.506V2.5zm1.068.5H7v-.5a1.5 1.5 0 1 0-3 0c0 .085.002.274.045.43a.522.522 0 0 0 .023.07zM9 3h2.932a.56.56 0 0 0 .023-.07c.043-.156.045-.345.045-.43a1.5 1.5 0 0 0-3 0V3zM1 4v2h6V4H1zm8 0v2h6V4H9zm5 3H9v8h4.5a.5.5 0 0 0 .5-.5V7zm-7 8V7H2v7.5a.5.5 0 0 0 .5.5H7z"/>
                    </svg>
                    View Market Data Prompt
                `;
            }
        }

        // Toggle system prompt visibility
        function toggleSystemPrompt() {
            const element = document.getElementById('system-prompt-content');
            const button = event.currentTarget;

            if (element.style.display === 'none') {
                element.style.display = 'block';
                button.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
                    </svg>
                    Hide System Prompt
                `;
            } else {
                element.style.display = 'none';
                button.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M3 2.5a2.5 2.5 0 0 1 5 0 2.5 2.5 0 0 1 5 0v.006c0 .07 0 .27-.038.494H15a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1v7.5a1.5 1.5 0 0 1-1.5 1.5h-11A1.5 1.5 0 0 1 1 14.5V7a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h2.038A2.968 2.968 0 0 1 3 2.506V2.5zm1.068.5H7v-.5a1.5 1.5 0 1 0-3 0c0 .085.002.274.045.43a.522.522 0 0 0 .023.07zM9 3h2.932a.56.56 0 0 0 .023-.07c.043-.156.045-.345.045-.43a1.5 1.5 0 0 0-3 0V3zM1 4v2h6V4H1zm8 0v2h6V4H9zm5 3H9v8h4.5a.5.5 0 0 0 .5-.5V7zm-7 8V7H2v7.5a.5.5 0 0 0 .5.5H7z"/>
                    </svg>
                    View System Prompt (Trading Instructions)
                `;
            }
        }

        // Update account stats
        async function updateAccount() {
            try {
                const response = await fetch(API.account);
                const data = await response.json();

                document.getElementById('balance').textContent = formatCurrency(data.balance_usd || 0);

                // Realized PnL (from closed trades)
                const realizedEl = document.getElementById('realized-pnl');
                realizedEl.textContent = formatCurrency(data.realized_pnl || 0);
                realizedEl.className = 'value ' + getPnLClass(data.realized_pnl || 0);

                // Unrealized PnL (from open positions)
                const unrealizedEl = document.getElementById('unrealized-pnl');
                unrealizedEl.textContent = formatCurrency(data.unrealized_pnl || 0);
                unrealizedEl.className = 'value ' + getPnLClass(data.unrealized_pnl || 0);
            } catch (error) {
                console.error('Error fetching account data:', error);
            }
        }

        // Update bot status
        async function updateStatus() {
            try {
                const response = await fetch(API.botStatus);
                const data = await response.json();

                const dot = document.getElementById('status-dot');
                const text = document.getElementById('status-text');
                const startBtn = document.getElementById('start-btn');
                const pauseBtn = document.getElementById('pause-btn');
                const stopBtn = document.getElementById('stop-btn');

                // Update status indicator
                const state = data.state || 'stopped';
                dot.className = 'status-indicator ' + state;
                text.textContent = state.charAt(0).toUpperCase() + state.slice(1);

                // Update button visibility based on state
                if (state === 'running') {
                    startBtn.style.display = 'none';
                    pauseBtn.style.display = 'flex';
                    stopBtn.style.display = 'flex';
                } else if (state === 'paused') {
                    startBtn.style.display = 'flex';
                    startBtn.textContent = 'Resume';
                    pauseBtn.style.display = 'none';
                    stopBtn.style.display = 'flex';
                } else {
                    startBtn.style.display = 'flex';
                    startBtn.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M5 3.5v9L12 8z"/>
                        </svg>
                        Start
                    `;
                    pauseBtn.style.display = 'none';
                    stopBtn.style.display = 'none';
                }
            } catch (error) {
                console.error('Error fetching status:', error);
            }
        }

        // Bot control functions
        async function startBot() {
            try {
                const response = await fetch(API.botStart, { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    console.log('Bot started');
                    updateStatus();
                } else {
                    alert('Failed to start bot: ' + data.message);
                }
            } catch (error) {
                alert('Error starting bot: ' + error.message);
            }
        }

        async function pauseBot() {
            try {
                const response = await fetch(API.botPause, { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    console.log('Bot paused');
                    updateStatus();
                } else {
                    alert('Failed to pause bot: ' + data.message);
                }
            } catch (error) {
                alert('Error pausing bot: ' + error.message);
            }
        }

        async function resumeBot() {
            try {
                const response = await fetch(API.botResume, { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    console.log('Bot resumed');
                    updateStatus();
                } else {
                    alert('Failed to resume bot: ' + data.message);
                }
            } catch (error) {
                alert('Error resuming bot: ' + error.message);
            }
        }

        async function stopBot() {
            try {
                const response = await fetch(API.botStop, { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    console.log('Bot stopped');
                    updateStatus();
                } else {
                    alert('Failed to stop bot: ' + data.message);
                }
            } catch (error) {
                alert('Error stopping bot: ' + error.message);
            }
        }

        // Track expanded sections to preserve state across updates
        let expandedSections = new Set();

        // Update decisions
        async function updateDecisions() {
            try {
                const response = await fetch(API.decisions + '?limit=50');
                const newDecisions = await response.json();

                // Only update if there's actually new data
                const hasNewData = JSON.stringify(newDecisions) !== JSON.stringify(allDecisions);

                if (!hasNewData && allDecisions.length > 0) {
                    // No changes, skip update to preserve expanded state
                    return;
                }

                allDecisions = newDecisions;

                if (allDecisions.length > 0) {
                    // Update total decisions count
                    document.getElementById('total-decisions').textContent = allDecisions.length;

                    // Show navigation controls if there are multiple decisions
                    const navControls = document.getElementById('decision-nav');
                    if (allDecisions.length > 1) {
                        navControls.style.display = 'flex';
                    } else {
                        navControls.style.display = 'none';
                    }

                    // Preserve current index if still valid, otherwise reset to 0
                    if (currentDecisionIndex >= allDecisions.length) {
                        currentDecisionIndex = 0;
                    }

                    // Show current decision
                    showDecisionAtIndex(currentDecisionIndex);

                    // Restore expanded sections
                    setTimeout(() => {
                        expandedSections.forEach(sectionId => {
                            const element = document.getElementById(sectionId);
                            if (element && element.style.display === 'none') {
                                const button = element.previousElementSibling;
                                if (button) button.click();
                            }
                        });
                    }, 100);
                } else {
                    document.getElementById('total-decisions').textContent = '0';
                    document.getElementById('decision-nav').style.display = 'none';
                }
            } catch (error) {
                console.error('Error fetching decisions:', error);
            }
        }

        // Show decision at specific index
        function showDecisionAtIndex(index) {
            if (index < 0 || index >= allDecisions.length) return;

            currentDecisionIndex = index;
            const decision = allDecisions[index];

            // Update the decision card
            document.getElementById('latest-decision-card').innerHTML = createDecisionCard(decision, true);

            // Update navigation controls
            updateNavigationControls();
        }

        // Update navigation controls state
        function updateNavigationControls() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const indicator = document.getElementById('nav-indicator');

            // Update indicator
            indicator.textContent = `${currentDecisionIndex + 1} of ${allDecisions.length}`;

            // Disable/enable buttons based on position
            // Previous (older) button disabled when at oldest decision
            prevBtn.disabled = currentDecisionIndex === allDecisions.length - 1;
            // Next (newer) button disabled when at newest decision
            nextBtn.disabled = currentDecisionIndex === 0;
        }

        // Update positions
        async function updatePositions() {
            try {
                const response = await fetch(API.positions + '?status=open');
                const positions = await response.json();

                const section = document.getElementById('positions-section');
                const list = document.getElementById('positions-list');

                if (positions.length === 0) {
                    section.style.display = 'none';
                } else {
                    section.style.display = 'block';
                    let html = '';
                    positions.forEach(pos => {
                        html += `
                            <div class="position-card">
                                <div class="position-header">
                                    <span class="position-coin">${pos.coin}</span>
                                    <span class="badge ${pos.side}">${pos.side.toUpperCase()}</span>
                                </div>
                                <div class="position-details">
                                    <span>Entry: $${pos.entry_price.toFixed(2)}</span>
                                    <span>Size: $${pos.quantity_usd.toFixed(2)}</span>
                                    <span>Leverage: ${pos.leverage}x</span>
                                </div>
                            </div>
                        `;
                    });
                    list.innerHTML = html;
                }
            } catch (error) {
                console.error('Error fetching positions:', error);
            }
        }

        // Update bot activity console
        async function updateActivity() {
            try {
                const response = await fetch(API.status);
                const data = await response.json();

                const console = document.getElementById('activity-console');
                const history = data.history || [];

                if (history.length === 0) {
                    console.innerHTML = '<div class="console-message">Waiting for bot activity...</div>';
                } else {
                    // Show last 10 activity logs in reverse chronological order
                    let html = '';
                    history.forEach(log => {
                        const timestamp = formatRelativeTime(log.timestamp);
                        const statusClass = log.status === 'error' ? 'error' :
                                           log.status === 'running' ? 'running' :
                                           'info';

                        const message = log.message || log.error || 'No message';

                        html += `
                            <div class="console-message ${statusClass}">
                                <span class="console-time">[${timestamp}]</span>
                                <span class="console-status">${log.status.toUpperCase()}</span>
                                <span class="console-text">${message}</span>
                            </div>
                        `;
                    });

                    console.innerHTML = html;

                    // Auto-scroll to bottom to show latest activity
                    console.scrollTop = console.scrollHeight;
                }

                // Load system prompt from most recent decision (only needs to be done once)
                if (allDecisions.length > 0) {
                    const latestDecision = allDecisions[0];
                    const systemPromptText = document.getElementById('system-prompt-text');

                    if (latestDecision.system_prompt) {
                        systemPromptText.textContent = latestDecision.system_prompt;
                    } else {
                        systemPromptText.textContent = 'System prompt not available in database.';
                    }
                }
            } catch (error) {
                console.error('Error fetching activity:', error);
            }
        }

        // Load debug database data
        async function loadDebugData() {
            const table = document.getElementById('debug-table-select').value;
            const container = document.getElementById('debug-entries');

            try {
                container.innerHTML = '<div style="color: #6c757d;">Loading...</div>';

                const response = await fetch(`${API.debugDatabase}?table=${table}&limit=3`);
                const data = await response.json();

                if (data.error) {
                    container.innerHTML = `<div style="color: #dc3545;">Error: ${data.error}</div>`;
                    return;
                }

                // Build HTML
                let html = `
                    <div style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #dee2e6;">
                        <strong>Table:</strong> ${data.table}<br>
                        <strong>Total Entries:</strong> ${data.total_count}<br>
                        <strong>Showing:</strong> ${data.entries.length} most recent
                    </div>
                `;

                if (data.entries.length === 0) {
                    html += '<div style="color: #6c757d; padding: 20px; text-align: center;">No entries found</div>';
                } else {
                    data.entries.forEach((entry, index) => {
                        html += `
                            <div style="margin-bottom: 20px; padding: 16px; background: white; border-radius: 4px; border-left: 4px solid #007bff;">
                                <div style="font-weight: bold; margin-bottom: 12px; color: #495057;">
                                    Entry #${entry.id || index + 1}
                                    ${entry.timestamp ? `<span style="float: right; font-weight: normal; color: #6c757d; font-size: 0.9em;">${new Date(entry.timestamp).toLocaleString()}</span>` : ''}
                                </div>
                                <pre style="background: #f8f9fa; padding: 12px; border-radius: 4px; overflow-x: auto; margin: 0; font-size: 0.85em; line-height: 1.5;"><code>${JSON.stringify(entry, null, 2)}</code></pre>
                            </div>
                        `;
                    });
                }

                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading debug data:', error);
                container.innerHTML = `<div style="color: #dc3545;">Failed to load data: ${error.message}</div>`;
            }
        }

        // Update all data
        async function updateAll() {
            await Promise.all([
                updateAccount(),
                updateStatus(),
                updateDecisions(),
                updatePositions(),
                updateActivity()
            ]);

            document.getElementById('last-update').textContent = new Date().toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Navigation buttons
        // Previous = older decision (came before chronologically) = higher index
        document.getElementById('prev-btn').addEventListener('click', () => {
            if (currentDecisionIndex < allDecisions.length - 1) {
                showDecisionAtIndex(currentDecisionIndex + 1);
            }
        });

        // Next = newer decision (came after chronologically) = lower index
        document.getElementById('next-btn').addEventListener('click', () => {
            if (currentDecisionIndex > 0) {
                showDecisionAtIndex(currentDecisionIndex - 1);
            }
        });

        // Bot control buttons
        document.getElementById('start-btn').addEventListener('click', () => {
            const btnText = document.getElementById('start-btn').textContent.trim();
            if (btnText === 'Resume') {
                resumeBot();
            } else {
                startBot();
            }
        });

        document.getElementById('pause-btn').addEventListener('click', () => {
            pauseBot();
        });

        document.getElementById('stop-btn').addEventListener('click', () => {
            stopBot();
        });

        // Initial load
        updateAll();
        loadDebugData(); // Load debug data on initial load

        // Auto-refresh every 30 seconds
        setInterval(updateAll, 30000);

        // Auto-refresh debug data every 60 seconds
        setInterval(loadDebugData, 60000);

        // Reload debug data when table selection changes
        document.getElementById('debug-table-select').addEventListener('change', loadDebugData);
    </script>
</body>
</html>
