<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alpha Arena Mini - Analysis Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <!-- Compact Header -->
        <header>
            <div class="header-top">
                <h1>Alpha Arena Mini</h1>
                <div class="header-controls">
                    <div class="bot-status-compact">
                        <span class="status-indicator unknown" id="status-dot"></span>
                        <span id="status-text">Stopped</span>
                    </div>
                    <div class="bot-controls">
                        <button class="bot-control-btn start-btn" id="start-btn">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M5 3.5v9L12 8z"/>
                            </svg>
                            Start
                        </button>
                        <button class="bot-control-btn pause-btn" id="pause-btn" style="display: none;">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M5 3h2v10H5V3zm4 0h2v10H9V3z"/>
                            </svg>
                            Pause
                        </button>
                        <button class="bot-control-btn stop-btn" id="stop-btn" style="display: none;">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <rect x="4" y="4" width="8" height="8"/>
                            </svg>
                            Stop
                        </button>
                    </div>
                </div>
            </div>
            <div class="header-stats-compact">
                <div class="stat-compact">
                    <span class="label">Balance</span>
                    <span class="value" id="balance">$0.00</span>
                </div>
                <div class="stat-compact">
                    <span class="label">Realized PnL</span>
                    <span class="value" id="realized-pnl">$0.00</span>
                </div>
                <div class="stat-compact">
                    <span class="label">Unrealized PnL</span>
                    <span class="value" id="unrealized-pnl">$0.00</span>
                </div>
                <div class="stat-compact">
                    <span class="label">Decisions</span>
                    <span class="value" id="total-decisions">0</span>
                </div>
                <div class="stat-compact">
                    <span class="label">Last Update</span>
                    <span class="value" id="last-update">Never</span>
                </div>
            </div>
        </header>

        <!-- Main Dashboard Grid Layout -->
        <div class="dashboard-grid">
            <!-- Main Content Area -->
            <div class="main-content">
                <!-- Latest Decision - Main Focus -->
                <section class="latest-decision" id="latest-decision-section">
                    <div class="section-header">
                        <h2>Latest Analysis</h2>
                        <div class="decision-nav" id="decision-nav" style="display: none;">
                            <button class="nav-btn" id="prev-btn" title="Previous decision">
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"/>
                                </svg>
                                Previous
                            </button>
                            <span class="nav-indicator" id="nav-indicator">1 of 1</span>
                            <button class="nav-btn" id="next-btn" title="Next decision">
                                Next
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="latest-decision-card">
                        <div class="no-data-card">No decisions yet. Run test_real_data.py to analyze market conditions.</div>
                    </div>
                </section>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Active Positions -->
                <div class="sidebar-section" id="sidebar-positions" style="display: none;">
                    <h3>Active Positions</h3>
                    <div id="positions-list"></div>
                </div>

                <!-- Bot Activity -->
                <div class="sidebar-section">
                    <h3>Activity Log</h3>
                    <div class="activity-console" id="activity-console">
                        <div class="console-message">Waiting for bot activity...</div>
                    </div>
                </div>

                <!-- Supervisor Input Section (Compact) -->
                <div class="sidebar-section">
                    <h3>Supervisor Input</h3>
                    <div class="input-container">
                        <textarea id="supervisor-message" placeholder="Enter bot guidance..." rows="2"></textarea>
                        <div class="input-actions">
                            <button id="send-input-btn" class="primary-btn">Send</button>
                            <button id="clear-input-btn" class="secondary-btn" style="display: none;">Clear</button>
                        </div>
                    </div>
                    <div id="active-input-display" style="display: none; margin-top: 12px; padding: 12px; background: rgba(40, 167, 69, 0.1); border-left: 4px solid #28a745; border-radius: 4px;">
                        <div style="font-size: 0.75em; color: #28a745; font-weight: bold; margin-bottom: 4px;">ACTIVE GUIDANCE</div>
                        <div id="active-input-text" style="color: var(--text-primary); font-size: 0.85em;"></div>
                        <div id="active-input-time" style="font-size: 0.7em; color: var(--text-muted); margin-top: 4px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Management Section (Redesigned) -->
        <section class="database-debug">
            <div class="section-header">
                <h2>Database Explorer</h2>
                <span class="activity-subtitle">View trading history and manage local data</span>
            </div>

            <div class="database-container">
                <!-- Tabs -->
                <div class="db-tabs">
                    <button class="db-tab active" onclick="switchDbTab('overview')">Overview</button>
                    <button class="db-tab" onclick="switchDbTab('decisions')">Decisions</button>
                    <button class="db-tab" onclick="switchDbTab('positions')">All Positions</button>
                    <button class="db-tab" onclick="switchDbTab('account')">Account History</button>
                    <button class="db-tab" onclick="switchDbTab('manage')">Manage</button>
                </div>

                <!-- Overview Tab -->
                <div class="db-tab-content active" id="db-tab-overview">
                    <div class="db-stats-grid" id="db-stats-grid">
                        <div class="db-stat-card">
                            <div class="db-stat-label">Total Decisions</div>
                            <div class="db-stat-value" id="stat-decisions">-</div>
                            <div class="db-stat-sublabel">All time</div>
                        </div>
                        <div class="db-stat-card">
                            <div class="db-stat-label">Total Positions</div>
                            <div class="db-stat-value" id="stat-positions">-</div>
                            <div class="db-stat-sublabel">Opened & closed</div>
                        </div>
                        <div class="db-stat-card">
                            <div class="db-stat-label">Open Positions</div>
                            <div class="db-stat-value" id="stat-open-positions">-</div>
                            <div class="db-stat-sublabel">Currently active</div>
                        </div>
                        <div class="db-stat-card">
                            <div class="db-stat-label">Database Size</div>
                            <div class="db-stat-value" id="stat-db-size">-</div>
                            <div class="db-stat-sublabel">MB</div>
                        </div>
                    </div>

                    <div style="padding: var(--spacing-md); background: var(--bg-tertiary); border-radius: var(--radius-md); border: 1px solid var(--border-primary);">
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: var(--spacing-sm);">
                            <strong>Database Path:</strong>
                        </div>
                        <div style="font-family: var(--font-mono); font-size: 0.75rem; color: var(--text-muted); word-break: break-all;" id="stat-db-path">
                            Loading...
                        </div>
                    </div>
                </div>

                <!-- Decisions Tab -->
                <div class="db-tab-content" id="db-tab-decisions">
                    <div class="data-table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Coin</th>
                                    <th>Signal</th>
                                    <th>Size</th>
                                    <th>Leverage</th>
                                    <th>Confidence</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="decisions-table-body">
                                <tr><td colspan="7" style="text-align: center; padding: var(--spacing-xl); color: var(--text-muted);">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Positions Tab -->
                <div class="db-tab-content" id="db-tab-positions">
                    <div class="data-table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Entry Time</th>
                                    <th>Coin</th>
                                    <th>Side</th>
                                    <th>Entry Price</th>
                                    <th>Size (USD)</th>
                                    <th>Leverage</th>
                                    <th>Exit Price</th>
                                    <th>Realized P&L</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="positions-table-body">
                                <tr><td colspan="9" style="text-align: center; padding: var(--spacing-xl); color: var(--text-muted);">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Account History Tab -->
                <div class="db-tab-content" id="db-tab-account">
                    <div class="data-table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Balance</th>
                                    <th>Equity</th>
                                    <th>Unrealized P&L</th>
                                    <th>Realized P&L</th>
                                    <th>Total P&L</th>
                                    <th>Open Positions</th>
                                </tr>
                            </thead>
                            <tbody id="account-table-body">
                                <tr><td colspan="7" style="text-align: center; padding: var(--spacing-xl); color: var(--text-muted);">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Manage Tab -->
                <div class="db-tab-content" id="db-tab-manage">
                    <div style="margin-bottom: var(--spacing-lg);">
                        <h3 style="font-size: 1rem; margin-bottom: var(--spacing-sm); color: var(--text-primary);">Database Actions</h3>
                        <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: var(--spacing-md);">
                            Manage your local SQLite database. Use these actions to reset data or start fresh.
                        </p>
                    </div>

                    <div class="db-actions">
                        <button class="db-action-btn danger" onclick="resetDatabase()">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path fill-rule="evenodd" d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.417A6 6 0 1 0 8 2v1z"/>
                                <path d="M8 4.466V.534a.25.25 0 0 0-.41-.192L5.23 2.308a.25.25 0 0 0 0 .384l2.36 1.966A.25.25 0 0 0 8 4.466z"/>
                            </svg>
                            Clear All Data
                        </button>
                        <div class="db-action-warning">
                            ⚠️ This will permanently delete all decisions, positions, and account history. This action cannot be undone.
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        // API endpoints
        const API = {
            account: '/api/account',
            account_history: '/api/account/history',
            decisions: '/api/decisions',
            positions: '/api/positions',
            status: '/api/status',
            stats: '/api/stats',
            botStatus: '/api/bot/status',
            botStart: '/api/bot/start',
            botPause: '/api/bot/pause',
            botResume: '/api/bot/resume',
            botStop: '/api/bot/stop',
            debugDatabase: '/api/debug/database',
            database_status: '/api/database/status'
        };

        let allDecisions = [];
        let currentDecisionIndex = 0;

        // Format currency
        function formatCurrency(value) {
            return '$' + value.toFixed(2);
        }

        // Format date/time
        function formatDateTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Format relative time
        function formatRelativeTime(isoString) {
            // Ensure UTC parsing by adding 'Z' if not present
            const utcString = isoString.endsWith('Z') ? isoString : isoString + 'Z';
            const date = new Date(utcString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours}h ago`;
            const diffDays = Math.floor(diffHours / 24);
            return `${diffDays}d ago`;
        }

        // Get PnL class
        function getPnLClass(value) {
            if (value > 0) return 'positive';
            if (value < 0) return 'negative';
            return 'neutral';
        }

        // Parse justification into structured sections
        function parseJustification(text) {
            const sections = {
                analysis: [],
                risks: [],
                waiting: [],
                other: []
            };

            // Split by periods and parse numbered points
            const sentences = text.split('. ');
            let currentSection = 'analysis';

            sentences.forEach(sentence => {
                const trimmed = sentence.trim();

                if (trimmed.includes('RISKS:')) {
                    currentSection = 'risks';
                } else if (trimmed.includes('WAITING for:')) {
                    currentSection = 'waiting';
                } else if (trimmed.match(/^\(\d+\)/)) {
                    // Numbered point
                    sections.analysis.push(trimmed);
                } else if (currentSection === 'risks' && trimmed.length > 0) {
                    sections.risks.push(trimmed);
                } else if (currentSection === 'waiting' && trimmed.length > 0) {
                    sections.waiting.push(trimmed);
                } else if (trimmed.length > 0) {
                    sections.other.push(trimmed);
                }
            });

            return sections;
        }

        // Create decision card HTML
        function createDecisionCard(decision, isLatest = false) {
            const sections = parseJustification(decision.justification);
            const timestamp = formatDateTime(decision.timestamp);
            const relativeTime = formatRelativeTime(decision.timestamp);

            const cardClass = isLatest ? 'decision-card latest' : 'decision-card';

            let html = `
                <div class="${cardClass}">
                    <div class="decision-header">
                        <div class="decision-meta">
                            <span class="decision-coin">${decision.coin}</span>
                            <span class="decision-time" title="${timestamp}">${relativeTime}</span>
                        </div>
                        <div class="decision-signal-badge ${decision.signal}">
                            ${decision.signal.toUpperCase().replace('_', ' ')}
                        </div>
                    </div>

                    <div class="decision-metrics">
                        <div class="metric">
                            <span class="metric-label">Confidence</span>
                            <span class="metric-value">${(decision.confidence * 100).toFixed(0)}%</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Size</span>
                            <span class="metric-value">$${decision.quantity_usd.toFixed(0)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Leverage</span>
                            <span class="metric-value">${decision.leverage}x</span>
                        </div>
            `;

            // Show entry price for buy/sell/hold decisions
            if ((decision.signal === 'buy_to_enter' || decision.signal === 'sell_to_enter' || decision.signal === 'hold') && decision.entry_price) {
                html += `
                        <div class="metric">
                            <span class="metric-label">Entry</span>
                            <span class="metric-value">$${decision.entry_price.toFixed(0)}</span>
                        </div>
                `;
            }

            // Show exit price and PnL for close decisions
            if (decision.signal === 'close' && decision.exit_price) {
                html += `
                        <div class="metric">
                            <span class="metric-label">Exit</span>
                            <span class="metric-value">$${decision.exit_price.toFixed(0)}</span>
                        </div>
                `;
                if (decision.realized_pnl !== null && decision.realized_pnl !== undefined) {
                    const pnlClass = decision.realized_pnl > 0 ? 'positive' : decision.realized_pnl < 0 ? 'negative' : '';
                    html += `
                        <div class="metric">
                            <span class="metric-label">PnL</span>
                            <span class="metric-value ${pnlClass}">$${decision.realized_pnl.toFixed(2)}</span>
                        </div>
                    `;
                }
            }

            // Continue with original metrics
            html += ``;

            if (decision.profit_target) {
                html += `
                        <div class="metric">
                            <span class="metric-label">Target</span>
                            <span class="metric-value positive">$${decision.profit_target.toFixed(0)}</span>
                        </div>
                `;
            }

            if (decision.stop_loss) {
                html += `
                        <div class="metric">
                            <span class="metric-label">Stop</span>
                            <span class="metric-value negative">$${decision.stop_loss.toFixed(0)}</span>
                        </div>
                `;
            }

            html += `</div>`;

            // Analysis section
            if (sections.analysis.length > 0) {
                html += `
                    <div class="analysis-section">
                        <h4>Analysis</h4>
                        <ul class="analysis-points">
                `;
                sections.analysis.forEach(point => {
                    // Remove existing (N) prefix if present since <li> will auto-number
                    const cleanPoint = point.replace(/^\(\d+\)\s*/, '');
                    html += `<li>${cleanPoint}</li>`;
                });
                html += `</ul></div>`;
            }

            // Risks section
            if (sections.risks.length > 0) {
                html += `
                    <div class="risks-section">
                        <h4>Risks Identified</h4>
                        <ul class="risk-points">
                `;
                sections.risks.forEach(risk => {
                    // Remove existing (N) prefix if present since <li> will auto-number
                    const cleanRisk = risk.replace(/^\(\d+\)\s*/, '');
                    html += `<li>${cleanRisk}</li>`;
                });
                html += `</ul></div>`;
            }

            // Waiting section
            if (sections.waiting.length > 0) {
                html += `
                    <div class="waiting-section">
                        <h4>Waiting For</h4>
                        <ul class="waiting-points">
                `;
                sections.waiting.forEach(condition => {
                    // Remove existing (N) prefix if present since <li> will auto-number
                    const cleanCondition = condition.replace(/^\(\d+\)\s*/, '');
                    html += `<li>${cleanCondition}</li>`;
                });
                html += `</ul></div>`;
            }

            // Other text
            if (sections.other.length > 0) {
                html += `
                    <div class="other-analysis">
                        <p>${sections.other.join('. ')}</p>
                    </div>
                `;
            }

            // Invalidation condition (if exists and not already in sections)
            if (decision.invalidation_condition && !decision.justification.includes('invalidation')) {
                html += `
                    <div class="invalidation">
                        <strong>Invalidation:</strong> ${decision.invalidation_condition}
                    </div>
                `;
            }

            // Raw data button and collapsible section
            const rawDataId = `raw-data-${decision.id}`;
            const rawData = {
                id: decision.id,
                timestamp: decision.timestamp,
                coin: decision.coin,
                signal: decision.signal,
                quantity_usd: decision.quantity_usd,
                leverage: decision.leverage,
                confidence: decision.confidence,
                exit_plan: {
                    profit_target: decision.profit_target,
                    stop_loss: decision.stop_loss,
                    invalidation_condition: decision.invalidation_condition
                },
                justification: decision.justification
            };

            // Add View Prompt buttons
            const userPromptId = `user-prompt-${decision.id}`;
            const systemPromptId = `system-prompt-${decision.id}`;
            const hasUserPrompt = decision.user_prompt && decision.user_prompt.length > 0;
            const hasSystemPrompt = decision.system_prompt && decision.system_prompt.length > 0;

            html += `
                <div class="decision-actions" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #eee; display: flex; gap: 8px; flex-wrap: wrap;">
                    ${hasSystemPrompt ? `
                    <button class="raw-data-btn" onclick="toggleSection('${systemPromptId}')">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
                        </svg>
                        System Prompt
                    </button>
                    ` : ''}

                    <button class="raw-data-btn" onclick="toggleSection('${rawDataId}')">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M5.854 4.646a.5.5 0 1 0-.708.708L8.293 8.5l-3.147 3.146a.5.5 0 0 0 .708.708l3.5-3.5a.5.5 0 0 0 0-.708l-3.5-3.5z"/>
                            <path d="M4.5 1a.5.5 0 0 0-.5.5v13a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5v-13a.5.5 0 0 0-.5-.5h-7zm0-1h7A1.5 1.5 0 0 1 13 1.5v13a1.5 1.5 0 0 1-1.5 1.5h-7A1.5 1.5 0 0 1 3 14.5v-13A1.5 1.5 0 0 1 4.5 0z"/>
                        </svg>
                        Raw Response
                    </button>
                </div>

                ${hasUserPrompt ? `
                <div class="raw-data-content" id="${userPromptId}" style="display: none;">
                    <h4 style="margin-top: 0; color: #333;">User Prompt (Market Data & Context):</h4>
                    <pre><code>${decision.user_prompt}</code></pre>
                </div>
                ` : ''}

                ${hasSystemPrompt ? `
                <div class="raw-data-content" id="${systemPromptId}" style="display: none;">
                    <h4 style="margin-top: 0; color: #333;">System Prompt (Instructions):</h4>
                    <pre><code>${decision.system_prompt}</code></pre>
                </div>
                ` : ''}

                <div class="raw-data-content" id="${rawDataId}" style="display: none;">
                    <h4 style="margin-top: 0; color: #333;">Raw JSON Response:</h4>
                    <pre><code>${JSON.stringify(rawData, null, 2)}</code></pre>
                </div>
            </div>
            `;

            html += `</div>`;
            return html;
        }

        // Generic toggle function
        function toggleSection(elementId) {
            const element = document.getElementById(elementId);
            const button = event.currentTarget; // The button that was clicked
            
            if (!element) return;

            if (element.style.display === 'none') {
                element.style.display = 'block';
                expandedSections.add(elementId);
                button.classList.add('active');
                button.style.backgroundColor = '#e9ecef';
            } else {
                element.style.display = 'none';
                expandedSections.delete(elementId);
                button.classList.remove('active');
                button.style.backgroundColor = '';
            }
        }

        // Update account stats
        async function updateAccount() {
            try {
                const response = await fetch(API.account);
                const data = await response.json();

                document.getElementById('balance').textContent = formatCurrency(data.balance_usd || 0);

                // Realized PnL (from closed trades)
                const realizedEl = document.getElementById('realized-pnl');
                realizedEl.textContent = formatCurrency(data.realized_pnl || 0);
                realizedEl.className = 'value ' + getPnLClass(data.realized_pnl || 0);

                // Unrealized PnL (from open positions)
                const unrealizedEl = document.getElementById('unrealized-pnl');
                unrealizedEl.textContent = formatCurrency(data.unrealized_pnl || 0);
                unrealizedEl.className = 'value ' + getPnLClass(data.unrealized_pnl || 0);
            } catch (error) {
                console.error('Error fetching account data:', error);
            }
        }

        // Update bot status
        async function updateStatus() {
            try {
                const response = await fetch(API.botStatus);
                const data = await response.json();

                const dot = document.getElementById('status-dot');
                const text = document.getElementById('status-text');
                const startBtn = document.getElementById('start-btn');
                const pauseBtn = document.getElementById('pause-btn');
                const stopBtn = document.getElementById('stop-btn');

                // Update status indicator
                const state = data.state || 'stopped';
                dot.className = 'status-indicator ' + state;
                text.textContent = state.charAt(0).toUpperCase() + state.slice(1);

                // Update button visibility based on state
                if (state === 'running') {
                    startBtn.style.display = 'none';
                    pauseBtn.style.display = 'flex';
                    stopBtn.style.display = 'flex';
                } else if (state === 'paused') {
                    startBtn.style.display = 'flex';
                    startBtn.textContent = 'Resume';
                    pauseBtn.style.display = 'none';
                    stopBtn.style.display = 'flex';
                } else {
                    startBtn.style.display = 'flex';
                    startBtn.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M5 3.5v9L12 8z"/>
                        </svg>
                        Start
                    `;
                    pauseBtn.style.display = 'none';
                    stopBtn.style.display = 'none';
                }
            } catch (error) {
                console.error('Error fetching status:', error);
            }
        }

        // Bot control functions
        async function startBot() {
            try {
                const response = await fetch(API.botStart, { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    console.log('Bot started');
                    updateStatus();
                } else {
                    alert('Failed to start bot: ' + data.message);
                }
            } catch (error) {
                alert('Error starting bot: ' + error.message);
            }
        }

        async function pauseBot() {
            try {
                const response = await fetch(API.botPause, { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    console.log('Bot paused');
                    updateStatus();
                } else {
                    alert('Failed to pause bot: ' + data.message);
                }
            } catch (error) {
                alert('Error pausing bot: ' + error.message);
            }
        }

        async function resumeBot() {
            try {
                const response = await fetch(API.botResume, { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    console.log('Bot resumed');
                    updateStatus();
                } else {
                    alert('Failed to resume bot: ' + data.message);
                }
            } catch (error) {
                alert('Error resuming bot: ' + error.message);
            }
        }

        async function stopBot() {
            try {
                const response = await fetch(API.botStop, { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    console.log('Bot stopped');
                    updateStatus();
                } else {
                    alert('Failed to stop bot: ' + data.message);
                }
            } catch (error) {
                alert('Error stopping bot: ' + error.message);
            }
        }

        // Track expanded sections to preserve state across updates
        let expandedSections = new Set();

        // Update decisions
        async function updateDecisions() {
            try {
                const response = await fetch(API.decisions + '?limit=50');
                const data = await response.json();

                // Handle new API format (returns object with decisions array and total_count)
                const newDecisions = data.decisions || data; // Fallback to array if old format
                const totalCount = data.total_count || newDecisions.length;

                // Only update if there's actually new data
                const hasNewData = JSON.stringify(newDecisions) !== JSON.stringify(allDecisions);

                if (!hasNewData && allDecisions.length > 0) {
                    // No changes, skip update to preserve expanded state
                    return;
                }

                allDecisions = newDecisions;

                if (allDecisions.length > 0) {
                    // Update total decisions count (show actual total, not just fetched)
                    document.getElementById('total-decisions').textContent = totalCount;

                    // Show navigation controls if there are multiple decisions
                    const navControls = document.getElementById('decision-nav');
                    if (allDecisions.length > 1) {
                        navControls.style.display = 'flex';
                    } else {
                        navControls.style.display = 'none';
                    }

                    // Preserve current index if still valid, otherwise reset to 0
                    if (currentDecisionIndex >= allDecisions.length) {
                        currentDecisionIndex = 0;
                    }

                    // Show current decision
                    showDecisionAtIndex(currentDecisionIndex);

                    // Restore expanded sections
                    setTimeout(() => {
                        expandedSections.forEach(sectionId => {
                            const element = document.getElementById(sectionId);
                            if (element && element.style.display === 'none') {
                                const button = element.previousElementSibling;
                                if (button) button.click();
                            }
                        });
                    }, 100);
                } else {
                    document.getElementById('total-decisions').textContent = '0';
                    document.getElementById('decision-nav').style.display = 'none';
                }
            } catch (error) {
                console.error('Error fetching decisions:', error);
            }
        }

        // Show decision at specific index
        function showDecisionAtIndex(index) {
            if (index < 0 || index >= allDecisions.length) return;

            currentDecisionIndex = index;
            const decision = allDecisions[index];

            // Update the decision card
            document.getElementById('latest-decision-card').innerHTML = createDecisionCard(decision, true);

            // Update navigation controls
            updateNavigationControls();
        }

        // Update navigation controls state
        function updateNavigationControls() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const indicator = document.getElementById('nav-indicator');

            // Update indicator
            indicator.textContent = `${currentDecisionIndex + 1} of ${allDecisions.length}`;

            // Disable/enable buttons based on position
            // Previous (older) button disabled when at oldest decision
            prevBtn.disabled = currentDecisionIndex === allDecisions.length - 1;
            // Next (newer) button disabled when at newest decision
            nextBtn.disabled = currentDecisionIndex === 0;
        }

        // Update positions
        async function updatePositions() {
            try {
                // --- Open Positions ---
                const response = await fetch(API.positions + '?status=open');
                const positions = await response.json();

                const section = document.getElementById('sidebar-positions');
                const list = document.getElementById('positions-list');

                if (positions.length === 0) {
                    section.style.display = 'none';
                } else {
                    section.style.display = 'block';
                    let html = '';
                    positions.forEach(pos => {
                        html += `
                            <div class="position-card">
                                <div class="position-header">
                                    <span class="position-coin">${pos.coin}</span>
                                    <span class="badge ${pos.side}">${pos.side.toUpperCase()}</span>
                                </div>
                                <div class="position-details">
                                    <span>Entry: $${pos.entry_price.toFixed(2)}</span>
                                    <span>Size: $${pos.quantity_usd.toFixed(2)}</span>
                                    <span>Leverage: ${pos.leverage}x</span>
                                </div>
                            </div>
                        `;
                    });
                    list.innerHTML = html;
                }

                // Closed positions removed - now available in Database Explorer "All Positions" tab

            } catch (error) {
                console.error('Error fetching positions:', error);
            }
        }

        // Update bot activity console
        async function updateActivity() {
            try {
                const response = await fetch(API.status);
                const data = await response.json();

                const console = document.getElementById('activity-console');
                const history = data.history || [];

                if (history.length === 0) {
                    console.innerHTML = '<div class="console-message">Waiting for bot activity...</div>';
                } else {
                    // Show last 10 activity logs in reverse chronological order
                    let html = '';
                    history.forEach(log => {
                        const timestamp = formatRelativeTime(log.timestamp);
                        const statusClass = log.status === 'error' ? 'error' :
                                           log.status === 'running' ? 'running' :
                                           'info';

                        const message = log.message || log.error || 'No message';

                        html += `
                            <div class="console-message ${statusClass}">
                                <span class="console-time">[${timestamp}]</span>
                                <span class="console-status">${log.status.toUpperCase()}</span>
                                <span class="console-text">${message}</span>
                            </div>
                        `;
                    });

                    console.innerHTML = html;

                    // Auto-scroll to bottom to show latest activity
                    console.scrollTop = console.scrollHeight;
                }

            } catch (error) {
                console.error('Error fetching activity:', error);
            }
        }

        // Load debug database data
        async function loadDebugData() {
            const table = document.getElementById('debug-table-select').value;
            const container = document.getElementById('debug-entries');

            try {
                container.innerHTML = '<div style="color: #6c757d;">Loading...</div>';

                const response = await fetch(`${API.debugDatabase}?table=${table}&limit=3`);
                const data = await response.json();

                if (data.error) {
                    container.innerHTML = `<div style="color: #dc3545;">Error: ${data.error}</div>`;
                    return;
                }

                // Build HTML
                let html = `
                    <div style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #dee2e6;">
                        <strong>Table:</strong> ${data.table}<br>
                        <strong>Total Entries:</strong> ${data.total_count}<br>
                        <strong>Showing:</strong> ${data.entries.length} most recent
                    </div>
                `;

                if (data.entries.length === 0) {
                    html += '<div style="color: #6c757d; padding: 20px; text-align: center;">No entries found</div>';
                } else {
                    data.entries.forEach((entry, index) => {
                        html += `
                            <div style="margin-bottom: 20px; padding: 16px; background: white; border-radius: 4px; border-left: 4px solid #007bff;">
                                <div style="font-weight: bold; margin-bottom: 12px; color: #495057;">
                                    Entry #${entry.id || index + 1}
                                    ${entry.timestamp ? `<span style="float: right; font-weight: normal; color: #6c757d; font-size: 0.9em;">${new Date(entry.timestamp).toLocaleString()}</span>` : ''}
                                </div>
                                <pre style="background: #f8f9fa; padding: 12px; border-radius: 4px; overflow-x: auto; margin: 0; font-size: 0.85em; line-height: 1.5;"><code>${JSON.stringify(entry, null, 2)}</code></pre>
                            </div>
                        `;
                    });
                }

                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading debug data:', error);
                container.innerHTML = `<div style="color: #dc3545;">Failed to load data: ${error.message}</div>`;
            }
        }

        // =====================================================================
        // DATABASE EXPLORER TAB FUNCTIONS
        // =====================================================================

        // Tab switching
        function switchDbTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.db-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.db-tab-content').forEach(content => content.classList.remove('active'));

            // Show selected tab
            document.querySelector(`.db-tab[onclick*="${tabName}"]`).classList.add('active');
            document.getElementById(`db-tab-${tabName}`).classList.add('active');

            // Load data for tab (only load if not already loaded)
            if (tabName === 'overview') loadDatabaseOverview();
            if (tabName === 'decisions') loadDecisionsTable();
            if (tabName === 'positions') loadPositionsTable();
            if (tabName === 'account') loadAccountTable();
        }

        // Load database overview stats
        async function loadDatabaseOverview() {
            try {
                const response = await fetch(API.database_status);
                const status = await response.json();

                document.getElementById('stat-decisions').textContent = status.table_counts?.decisions || 0;
                document.getElementById('stat-positions').textContent = status.table_counts?.positions || 0;
                document.getElementById('stat-open-positions').textContent = status.table_counts?.open_positions || 0;
                document.getElementById('stat-db-size').textContent = (status.database_size_mb || 0).toFixed(2);
                document.getElementById('stat-db-path').textContent = status.database_path || 'Unknown';
            } catch (error) {
                console.error('Failed to load database overview:', error);
            }
        }

        // Load decisions table
        async function loadDecisionsTable() {
            try {
                const response = await fetch(API.decisions + '?limit=100');
                const data = await response.json();
                const decisions = data.decisions || data;

                const tbody = document.getElementById('decisions-table-body');
                if (decisions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: var(--spacing-xl); color: var(--text-muted);">No decisions found</td></tr>';
                    return;
                }

                tbody.innerHTML = decisions.map(d => {
                    const time = new Date(d.timestamp).toLocaleString('en-US', {month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'});
                    const statusBadge = d.execution_status === 'success' ? 'success' :
                                      d.execution_status === 'failed' ? 'error' : 'pending';
                    return `
                        <tr>
                            <td>${time}</td>
                            <td>${d.coin}</td>
                            <td><span class="decision-signal-badge ${d.signal}">${d.signal.replace('_', ' ')}</span></td>
                            <td>$${d.quantity_usd?.toFixed(2) || '0.00'}</td>
                            <td>${d.leverage?.toFixed(1) || '1.0'}x</td>
                            <td>${((d.confidence || 0) * 100).toFixed(0)}%</td>
                            <td><span class="data-badge ${statusBadge}">${d.execution_status || 'pending'}</span></td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Failed to load decisions:', error);
                document.getElementById('decisions-table-body').innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--color-loss);">Error loading decisions</td></tr>';
            }
        }

        // Load positions table
        async function loadPositionsTable() {
            try {
                const response = await fetch(API.positions + '?status=all&limit=100');
                const positions = await response.json();

                const tbody = document.getElementById('positions-table-body');
                if (positions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: var(--spacing-xl); color: var(--text-muted);">No positions found</td></tr>';
                    return;
                }

                tbody.innerHTML = positions.map(p => {
                    const entryTime = new Date(p.entry_time).toLocaleString('en-US', {month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'});
                    const exitPrice = p.exit_price ? `$${p.exit_price.toFixed(2)}` : '-';
                    const pnl = p.realized_pnl ? `$${p.realized_pnl.toFixed(2)}` : '-';
                    const pnlClass = p.realized_pnl > 0 ? 'positive' : p.realized_pnl < 0 ? 'negative' : '';
                    const statusBadge = p.status === 'open' ? 'pending' : 'success';

                    return `
                        <tr>
                            <td>${entryTime}</td>
                            <td>${p.coin}</td>
                            <td><span class="badge ${p.side}">${p.side}</span></td>
                            <td>$${p.entry_price?.toFixed(2) || '0.00'}</td>
                            <td>$${p.quantity_usd?.toFixed(2) || '0.00'}</td>
                            <td>${p.leverage?.toFixed(1) || '1.0'}x</td>
                            <td>${exitPrice}</td>
                            <td class="${pnlClass}">${pnl}</td>
                            <td><span class="data-badge ${statusBadge}">${p.status}</span></td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Failed to load positions:', error);
                document.getElementById('positions-table-body').innerHTML = '<tr><td colspan="9" style="text-align: center; color: var(--color-loss);">Error loading positions</td></tr>';
            }
        }

        // Load account history table
        async function loadAccountTable() {
            try {
                const response = await fetch(API.account_history + '?limit=50');
                const history = await response.json();

                const tbody = document.getElementById('account-table-body');
                if (history.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: var(--spacing-xl); color: var(--text-muted);">No account history found</td></tr>';
                    return;
                }

                tbody.innerHTML = history.map(h => {
                    const time = new Date(h.timestamp).toLocaleString('en-US', {month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'});
                    const unrealizedClass = (h.unrealized_pnl || 0) > 0 ? 'positive' : (h.unrealized_pnl || 0) < 0 ? 'negative' : '';
                    const realizedClass = (h.realized_pnl || 0) > 0 ? 'positive' : (h.realized_pnl || 0) < 0 ? 'negative' : '';
                    const totalClass = (h.total_pnl || 0) > 0 ? 'positive' : (h.total_pnl || 0) < 0 ? 'negative' : '';

                    return `
                        <tr>
                            <td>${time}</td>
                            <td>$${h.balance_usd?.toFixed(2) || '0.00'}</td>
                            <td>$${h.equity_usd?.toFixed(2) || '0.00'}</td>
                            <td class="${unrealizedClass}">$${h.unrealized_pnl?.toFixed(2) || '0.00'}</td>
                            <td class="${realizedClass}">$${h.realized_pnl?.toFixed(2) || '0.00'}</td>
                            <td class="${totalClass}">$${h.total_pnl?.toFixed(2) || '0.00'}</td>
                            <td>${h.num_positions || 0}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Failed to load account history:', error);
                document.getElementById('account-table-body').innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--color-loss);">Error loading account history</td></tr>';
            }
        }

        // Load database status (LEGACY - keeping for compatibility)
        async function loadDatabaseStatus() {
            const container = document.getElementById('database-status-display');
            
            try {
                container.innerHTML = '<div style="color: #6c757d;">Loading database status...</div>';
                
                const response = await fetch('/api/database/status');
                const data = await response.json();
                
                if (data.error) {
                    container.innerHTML = `<div style="color: #dc3545;">Error: ${data.error}</div>`;
                    return;
                }
                
                // Build status HTML
                let html = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                        <div>
                            <div style="font-weight: 600; color: #212529; margin-bottom: 4px;">Database Path</div>
                            <div style="color: #6c757d; font-size: 0.8rem; word-break: break-all;">${data.database_path}</div>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: #212529; margin-bottom: 4px;">Size</div>
                            <div style="color: #6c757d;">${data.database_size_mb} MB (${data.database_size_bytes.toLocaleString()} bytes)</div>
                        </div>
                    </div>
                    
                    <div style="border-top: 1px solid #dee2e6; padding-top: 12px; margin-top: 12px;">
                        <div style="font-weight: 600; color: #212529; margin-bottom: 8px;">Table Counts</div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                            <div style="background: white; padding: 8px; border-radius: 4px; border-left: 3px solid #007bff;">
                                <div style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase;">Decisions</div>
                                <div style="font-size: 1.25rem; font-weight: 600; color: #212529;">${data.table_counts.decisions.toLocaleString()}</div>
                            </div>
                            <div style="background: white; padding: 8px; border-radius: 4px; border-left: 3px solid #28a745;">
                                <div style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase;">Positions</div>
                                <div style="font-size: 1.25rem; font-weight: 600; color: #212529;">${data.table_counts.positions.toLocaleString()}</div>
                            </div>
                            <div style="background: white; padding: 8px; border-radius: 4px; border-left: 3px solid #ffc107;">
                                <div style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase;">Open Positions</div>
                                <div style="font-size: 1.25rem; font-weight: 600; color: #212529;">${data.table_counts.open_positions.toLocaleString()}</div>
                            </div>
                            <div style="background: white; padding: 8px; border-radius: 4px; border-left: 3px solid #17a2b8;">
                                <div style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase;">Account State</div>
                                <div style="font-size: 1.25rem; font-weight: 600; color: #212529;">${data.table_counts.account_state.toLocaleString()}</div>
                            </div>
                            <div style="background: white; padding: 8px; border-radius: 4px; border-left: 3px solid #6610f2;">
                                <div style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase;">Bot Status</div>
                                <div style="font-size: 1.25rem; font-weight: 600; color: #212529;">${data.table_counts.bot_status.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="border-top: 1px solid #dee2e6; padding-top: 12px; margin-top: 12px; font-size: 0.8rem; color: #6c757d;">
                        <div>Last Decision: ${data.latest_timestamps.decision || 'N/A'}</div>
                        <div>Last Account Update: ${data.latest_timestamps.account_state || 'N/A'}</div>
                        <div>Status Updated: ${new Date(data.last_updated).toLocaleString()}</div>
                    </div>
                `;
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading database status:', error);
                container.innerHTML = `<div style="color: #dc3545;">Failed to load status: ${error.message}</div>`;
            }
        }

        // Reset database with confirmation
        async function resetDatabase() {
            // Confirmation dialog
            const confirmed = confirm(
                '⚠️ WARNING: This will permanently delete ALL data from the local database!\n\n' +
                'This includes:\n' +
                '  • All trading decisions\n' +
                '  • Position history\n' +
                '  • Account state snapshots\n' +
                '  • Bot activity logs\n\n' +
                'Are you absolutely sure you want to continue?'
            );
            
            if (!confirmed) {
                console.log('Database reset cancelled by user');
                return;
            }
            
            try {
                console.log('Resetting database...');
                
                const response = await fetch('/api/database/reset', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('✓ Database reset successfully!\n\nAll local data has been cleared.');
                    
                    // Reload database status to show empty tables
                    await loadDatabaseStatus();
                    
                    // Refresh dashboard data
                    await updateAll();
                } else {
                    alert('✗ Failed to reset database:\n' + data.message);
                }
                
            } catch (error) {
                console.error('Error resetting database:', error);
                alert('✗ Error resetting database:\n' + error.message);
            }
        }

        // Update all data
        async function updateAll() {
            await Promise.all([
                updateAccount(),
                updateStatus(),
                updateDecisions(),
                updatePositions(),
                updateActivity(),
                loadDatabaseOverview()
            ]);

            document.getElementById('last-update').textContent = new Date().toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Navigation buttons
        // Previous = older decision (came before chronologically) = higher index
        document.getElementById('prev-btn').addEventListener('click', () => {
            if (currentDecisionIndex < allDecisions.length - 1) {
                showDecisionAtIndex(currentDecisionIndex + 1);
            }
        });

        // Next = newer decision (came after chronologically) = lower index
        document.getElementById('next-btn').addEventListener('click', () => {
            if (currentDecisionIndex > 0) {
                showDecisionAtIndex(currentDecisionIndex - 1);
            }
        });

        // Bot control buttons
        document.getElementById('start-btn').addEventListener('click', () => {
            const btnText = document.getElementById('start-btn').textContent.trim();
            if (btnText === 'Resume') {
                resumeBot();
            } else {
                startBot();
            }
        });

        document.getElementById('pause-btn').addEventListener('click', () => {
            pauseBot();
        });

        document.getElementById('stop-btn').addEventListener('click', () => {
            stopBot();
        });

        // Initial load
        updateAll();
        loadDebugData(); // Load debug data on initial load
        loadDatabaseStatus(); // Load database status on initial load

        // Auto-refresh every 30 seconds
        setInterval(updateAll, 30000);

        // Auto-refresh debug data every 60 seconds
        setInterval(loadDebugData, 60000);
        
        // Auto-refresh database status every 60 seconds
        setInterval(loadDatabaseStatus, 60000);

        // Reload debug data when table selection changes
        document.getElementById('debug-table-select').addEventListener('change', loadDebugData);

        // --- Supervisor Input Logic ---
        
        async function loadActiveInput() {
            try {
                const response = await fetch('/api/user_input');
                const data = await response.json();
                
                const display = document.getElementById('active-input-display');
                const text = document.getElementById('active-input-text');
                const time = document.getElementById('active-input-time');
                const clearBtn = document.getElementById('clear-input-btn');
                const indicator = document.getElementById('input-status-indicator');
                
                if (data.message) {
                    display.style.display = 'block';
                    text.textContent = data.message;
                    time.textContent = 'Set: ' + new Date(data.timestamp).toLocaleString();
                    clearBtn.style.display = 'inline-block';
                    indicator.style.display = 'inline-block';
                    indicator.textContent = 'Active Guidance';
                    indicator.className = 'status-indicator running'; // Green
                } else {
                    display.style.display = 'none';
                    clearBtn.style.display = 'none';
                    indicator.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading active input:', error);
            }
        }
        
        async function sendInput() {
            const textarea = document.getElementById('supervisor-message');
            const message = textarea.value.trim();
            
            if (!message) return;
            
            try {
                const response = await fetch('/api/user_input', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    textarea.value = '';
                    loadActiveInput();
                } else {
                    alert('Failed to send input: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error sending input:', error);
                alert('Error sending input');
            }
        }
        
        async function clearInput() {
            if (!confirm('Clear the active guidance?')) return;
            
            try {
                const response = await fetch('/api/user_input', { method: 'DELETE' });
                const data = await response.json();
                
                if (data.success) {
                    loadActiveInput();
                }
            } catch (error) {
                console.error('Error clearing input:', error);
            }
        }
        
        document.getElementById('send-input-btn').addEventListener('click', sendInput);
        document.getElementById('clear-input-btn').addEventListener('click', clearInput);
        
        // Load input on start and refresh
        loadActiveInput();
        setInterval(loadActiveInput, 10000); // Check every 10s

    </script>
</body>
</html>
